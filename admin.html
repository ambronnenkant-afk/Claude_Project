<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — Service Requests</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f4f8;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    .container { max-width: 1100px; margin: 0 auto; }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header h1 { font-size: 1.6rem; font-weight: 700; color: #1a202c; }
    .header p  { color: #718096; font-size: 0.9rem; margin-top: 0.2rem; }

    .badge {
      background: #3182ce;
      color: #fff;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .toolbar {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 7px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }

    .btn-primary { background: #3182ce; color: #fff; }
    .btn-primary:hover { background: #2b6cb0; }
    .btn-secondary { background: #fff; color: #4a5568; border: 1.5px solid #cbd5e0; }
    .btn-secondary:hover { background: #edf2f7; }

    input[type="search"] {
      padding: 0.5rem 0.85rem;
      border: 1.5px solid #cbd5e0;
      border-radius: 7px;
      font-size: 0.9rem;
      width: 220px;
      color: #2d3748;
    }

    input[type="search"]:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66,153,225,0.15);
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.07);
      overflow: hidden;
    }

    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }

    thead {
      background: #f7fafc;
      border-bottom: 2px solid #e2e8f0;
    }

    th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-size: 0.78rem;
      font-weight: 700;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }

    th:hover { color: #2d3748; }
    th .sort-icon { margin-left: 4px; opacity: 0.4; }
    th.sorted .sort-icon { opacity: 1; color: #3182ce; }

    td {
      padding: 0.85rem 1rem;
      border-bottom: 1px solid #edf2f7;
      color: #2d3748;
      vertical-align: top;
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f7fafc; }

    .td-name    { font-weight: 600; white-space: nowrap; }
    .td-email   { color: #3182ce; }
    .td-phone   { white-space: nowrap; }
    .td-address { min-width: 160px; }
    .td-notes   { max-width: 240px; color: #4a5568; }
    .td-date    { white-space: nowrap; color: #718096; font-size: 0.82rem; }

    .btn-delete {
      background: none;
      border: 1.5px solid #feb2b2;
      color: #e53e3e;
      border-radius: 6px;
      padding: 0.3rem 0.65rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s, color 0.15s;
    }
    .btn-delete:hover { background: #e53e3e; color: #fff; border-color: #e53e3e; }

    .notes-text {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      cursor: pointer;
    }

    .notes-text.expanded {
      display: block;
      -webkit-line-clamp: unset;
    }

    .empty-state {
      padding: 4rem 2rem;
      text-align: center;
      color: #a0aec0;
    }

    .empty-state svg { margin-bottom: 1rem; opacity: 0.4; }
    .empty-state p { font-size: 1rem; }

    .loading {
      padding: 4rem 2rem;
      text-align: center;
      color: #a0aec0;
      font-size: 0.95rem;
    }

    @media (max-width: 600px) {
      th, td { padding: 0.65rem 0.6rem; }
      input[type="search"] { width: 100%; }
    }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <div>
      <h1>Service Requests <span class="badge" id="count">0</span></h1>
      <p>All submitted service request forms</p>
    </div>
    <div class="toolbar">
      <input type="search" id="searchInput" placeholder="Search submissions…" />
      <a href="/" class="btn btn-secondary">+ New Request</a>
      <button class="btn btn-primary" onclick="loadSubmissions()">Refresh</button>
    </div>
  </div>

  <div class="card">
    <div class="table-wrap">
      <table id="table">
        <thead>
          <tr>
            <th data-col="submitted_at" class="sorted">Date <span class="sort-icon">▼</span></th>
            <th data-col="name">Name <span class="sort-icon">↕</span></th>
            <th data-col="email">Email <span class="sort-icon">↕</span></th>
            <th data-col="phone">Phone <span class="sort-icon">↕</span></th>
            <th>Address</th>
            <th>Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="loading">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
  let allData = [];
  let sortCol = 'submitted_at';
  let sortDir = -1; // -1 = desc, 1 = asc

  async function loadSubmissions() {
    try {
      const res = await fetch('/submissions');
      allData = await res.json();
      render();
    } catch (e) {
      document.getElementById('tbody').innerHTML =
        '<tr><td colspan="6" class="empty-state"><p>Failed to load submissions.</p></td></tr>';
    }
  }

  function formatDate(iso) {
    const d = new Date(iso);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
      + '<br><span style="color:#a0aec0">' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + '</span>';
  }

  function formatAddress(addr) {
    return `${addr.street}<br>${addr.city}, ${addr.state} ${addr.zip}`;
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function render() {
    const query = document.getElementById('searchInput').value.toLowerCase();

    let data = allData.filter(r => {
      const haystack = [r.name, r.email, r.phone, r.notes,
        r.address.street, r.address.city, r.address.state, r.address.zip]
        .join(' ').toLowerCase();
      return haystack.includes(query);
    });

    data.sort((a, b) => {
      let av = sortCol === 'submitted_at' ? a[sortCol] : (a[sortCol] || '').toLowerCase();
      let bv = sortCol === 'submitted_at' ? b[sortCol] : (b[sortCol] || '').toLowerCase();
      return av < bv ? sortDir : av > bv ? -sortDir : 0;
    });

    document.getElementById('count').textContent = allData.length;

    const tbody = document.getElementById('tbody');
    if (data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><p>${query ? 'No results match your search.' : 'No submissions yet.'}</p></td></tr>`;
      return;
    }

    tbody.innerHTML = data.map(r => `
      <tr>
        <td class="td-date">${formatDate(r.submitted_at)}</td>
        <td class="td-name">${escapeHtml(r.name)}</td>
        <td class="td-email"><a href="mailto:${escapeHtml(r.email)}">${escapeHtml(r.email)}</a></td>
        <td class="td-phone">${escapeHtml(r.phone)}</td>
        <td class="td-address">${formatAddress(r.address)}</td>
        <td class="td-notes"><div class="notes-text" onclick="this.classList.toggle('expanded')" title="Click to expand">${escapeHtml(r.notes)}</div></td>
        <td><button class="btn-delete" onclick="deleteSubmission('${r.id}', '${escapeHtml(r.name)}')">Delete</button></td>
      </tr>
    `).join('');
  }

  // Sorting
  document.querySelectorAll('th[data-col]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      if (sortCol === col) { sortDir *= -1; }
      else { sortCol = col; sortDir = -1; }

      document.querySelectorAll('th').forEach(t => {
        t.classList.remove('sorted');
        t.querySelector('.sort-icon').textContent = '↕';
      });
      th.classList.add('sorted');
      th.querySelector('.sort-icon').textContent = sortDir === -1 ? '▼' : '▲';
      render();
    });
  });

  // Live search
  document.getElementById('searchInput').addEventListener('input', render);

  async function deleteSubmission(id, name) {
    if (!confirm(`Delete submission from "${name}"?`)) return;
    try {
      const res = await fetch(`/submissions/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed');
      allData = allData.filter(r => r.id !== id);
      render();
    } catch (e) {
      alert('Failed to delete submission.');
    }
  }

  loadSubmissions();
</script>
</body>
</html>
